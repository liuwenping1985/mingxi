<?xml version="1.0" encoding="UTF-8"?>
<sqlcfg>
	<report>
		<FlowSentAndCompletedStatisticsForm>
			<main>
				<sql1>
			     <![CDATA[
			     SELECT (CASE WHEN 2=affair.state THEN CONVERT(VARCHAR(7), affair.CREATE_DATE, 23) 
                 WHEN 4=affair.state THEN CONVERT(VARCHAR(7), affair.COMPLETE_TIME, 23) END) as '时间',
                 COUNT(affair.id) as '数量',col.templete_Id as '模板'  
                 FROM Ctp_Affair affair INNER JOIN Col_Summary col ON affair.object_Id=col.id and affair.BODY_TYPE=20  
                 INNER JOIN Org_Member member ON affair.member_Id=member.id AND member.id=:user  
                 WHERE affair.app=1 AND affair.state IN(:state) AND col.templete_Id IN(:templeteIds) 
                 AND (CASE WHEN 2=affair.state AND DATEDIFF(MONTH,:startTime, affair.CREATE_DATE)>=0 AND DATEDIFF(MONTH, affair.CREATE_DATE,:endTime)>=0 THEN 1  
                 WHEN 4=affair.state AND DATEDIFF(MONTH,:startTime, affair.COMPLETE_TIME)>=0 AND DATEDIFF(MONTH, affair.COMPLETE_TIME,:endTime)>=0 THEN 1 ELSE 0 END)=1 
                 GROUP BY (CASE WHEN 2=affair.state THEN CONVERT(VARCHAR(7), affair.CREATE_DATE, 23) 
                 WHEN 4=affair.state THEN CONVERT(VARCHAR(7), affair.COMPLETE_TIME, 23) END),col.templete_Id  
                 ORDER BY 时间 
			     ]]>
				</sql1>
			</main>
			<getTopTemplete>
                <sql1>
                <![CDATA[
                SELECT col.TEMPLETE_ID as 'templeteId',template.SUBJECT as 'TemplateName'
                FROM Ctp_Affair affair INNER JOIN Col_Summary col ON affair.object_Id=col.id and affair.BODY_TYPE=20  
                INNER JOIN Org_Member member ON affair.member_Id=member.id AND member.id=:user  
                INNER JOIN CTP_TEMPLATE template ON col.TEMPLETE_ID IS NOT NULL AND col.TEMPLETE_ID=template.id  
                WHERE affair.app=1 AND affair.state IN (:state) AND affair.is_delete=0 AND col.TEMPLETE_ID IS NOT NULL 
                AND (CASE WHEN 2=affair.state AND DATEDIFF(MONTH,:startTime, affair.CREATE_DATE)>=0 AND DATEDIFF(MONTH, affair.CREATE_DATE,:endTime)>=0 THEN 1 
                WHEN 4=affair.state AND DATEDIFF(MONTH,:startTime, affair.COMPLETE_TIME)>=0 AND DATEDIFF(MONTH, affair.COMPLETE_TIME,:endTime)>=0 THEN 1 ELSE 0 END)=1 
                GROUP BY col.TEMPLETE_ID,template.SUBJECT 
                ORDER BY count(*) desc
                ]]>
                </sql1>
			</getTopTemplete>
		</FlowSentAndCompletedStatisticsForm>
	</report>
</sqlcfg>
            