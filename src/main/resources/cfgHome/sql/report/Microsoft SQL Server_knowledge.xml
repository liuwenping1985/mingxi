<?xml version="1.0" encoding="UTF-8"?>
<sqlcfg>
	<report>
		<StorageSpaceStatistics>
			<main>
				<subjectReport>
				<![CDATA[
				SELECT mem.NAME AS "人员", dep.NAME AS "部门",sp.USED_SPACE_SIZE AS "文档空间(M)",sp.BLOG_USED_SPACE AS "博客空间(M)", 
				sp.MAIL_USED_SPACE AS "邮件空间(M)"																                                                      
				FROM doc_storage_spaces sp                                                                                                
				LEFT JOIN org_member mem ON sp.USER_ID=mem.id LEFT JOIN org_unit dep ON dep.id=mem.ORG_DEPARTMENT_ID                      
				WHERE sp.USER_ID IN (:users_id)     
				order by (sp.USED_SPACE_SIZE +sp.BLOG_USED_SPACE+sp.MAIL_USED_SPACE)  desc ,mem.sort_id                   
				]]>
				</subjectReport>
			</main>
		</StorageSpaceStatistics>
        <StorageSpaceAccountAvg>
			<main>
				<subjectReport>
				<![CDATA[
				SELECT account.ID AS account_id,account.NAME AS '单位',sum(sp.USED_SPACE_SIZE) AS total_doc_space,sum(sp.BLOG_USED_SPACE) AS total_blog_space, 
				sum(sp.MAIL_USED_SPACE) AS total_mail_space,sum(sp.USED_SPACE_SIZE +sp.BLOG_USED_SPACE+sp.MAIL_USED_SPACE) AS total_space                        
				FROM doc_storage_spaces sp                                                                                                                       
				LEFT JOIN org_member mem ON sp.USER_ID=mem.id LEFT JOIN org_unit account ON account.id=mem.ORG_ACCOUNT_ID                                        
				WHERE account.ID IN (:account_id)    
				GROUP BY  account.ID,account.NAME
				]]>
				</subjectReport>
			</main>
		</StorageSpaceAccountAvg>		
		<KnowledgeActivityStatistics>
			<depAverage>
				<![CDATA[
				select '本部门平均值' as '人员', sum(docnum) as '创建文档数量',sum(commitnum) as '评论/评分次数', sum(favnum) as '收藏次数',sum(clicknum) as '点击阅读次数',
				sum(publishblognum) as '发布博客', sum(sendtolearn) as '发送学习区' from ( 
				select * from (
				                                                                    
				select activity.user_id, mem.name as per, sum(activity.docnum) as docnum  , sum(activity.commitnum) as commitnum,  sum(activity.favnum) as favnum,  sum(activity.clicknum) as clicknum,                                          
				sum(activity.publishblognum) as publishblognum, sum(activity.sendtolearn) as sendtolearn                                                                                           
				from(                                                                                                                                                                 
				select t.create_user_id as user_id,count(*) as docnum , 0 as commitnum , 0 as favnum, 0 as clicknum,0 as publishblognum,0 as sendtolearn                                                        
					from doc_resources t 	                                                                                                                                               
				left join org_member m on m.id=t.create_user_id                                                                                                                                                                                  
					where m.org_department_id=:dep_id and t.create_time>:start_time and t.create_time<:end_time 
					and ( t.FR_TYPE not in (110,111) and ( t.FR_TYPE >52 or t.FR_TYPE < 31 )	)						                                                                                                                            
					group by t.create_user_id                                                                                                                                            
				union                                                                                                                                                                                                      
					select t.action_user_id as user_id, 0 as docnum,                                                                                                                                                                  
					sum(case when t.action_type in (14,15) then 1 else 0 end) as commitnum,                                                                                                                                           
					sum(case when t.action_type =12 then 1 else 0 end) as favnum,                                                                                                                                               
					sum(case when t.action_type =3 then 1 else 0 end) as clicknum,0 as publishblognum,                                                                                                                                
					sum(case when t.action_type =18 then 1 else 0 end) as sendtolearn                                                                                                                                       
					from doc_action t  left join org_member m on m.id=t.action_user_id                                                                                                                                                                                                    
					where m.org_department_id=:dep_id	and t.action_time>:start_time and t.action_time<:end_time                                                                                                                                                                           
					group by t.action_user_id                                                                                                                                            
				union                                                                                                                                                                                                             
				                                                                                                                                                                                                                   
					select t.employee_id as user_id,0 as docnum , 0 as commitnum, 0 as favnum, 0 as clicknum,count(*) as publishblognum,0 as sendtolearn                                                                   
					from blog_article t   left join org_member m on m.id=t.employee_id                                                                                                                                                                                                   
					where m.org_department_id=:dep_id and t.issue_time>:start_time and t.issue_time<:end_time 				                                                                                                                                                                   
					group by  t.employee_id                                                                                                                                                                                        
				)                                                                                                                                                                                                                  
				activity                                                                                                                                                                                                           
				left join                                                                                                                                                                                                          
				org_member mem on mem.id=user_id                                                                                                                                                                                   
				group by activity.user_id,mem.name) tmp                                                                                                                                                                                              
				where tmp.per is not null
				
				union
				
				select 0 as user_id, '本部门平均值' as per,0 as "创建文档数量",
				0 as "评论/评分次数", 
				0 as "收藏次数",
				0 as "点击阅读次数",
				0 as "发布博客", 
				0 as "发送学习区" 
				
				) tmp_final
				]]>
			</depAverage>
		</KnowledgeActivityStatistics>
	</report>
</sqlcfg>